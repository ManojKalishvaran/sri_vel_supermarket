<!-- index.html (updated) -->
<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHRI VELAVAN SUPER MARKET - Billing system</title>
    <style>
        /* Autocomplete suggestion box */
        #productSuggestions {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        z-index: 2000;
        max-height: 220px;
        overflow-y: auto;
        width: calc(100% - 28px); /* tweak to fit your layout */
        border-radius: 6px;
        padding: 4px 0;
        }
        .suggestion-item {
        padding: 8px 10px;
        cursor: pointer;
        font-size: 14px;
        color: #2d3748;
        }
        .suggestion-item:hover, .suggestion-active {
        background: #f1f5f9;
        }
        .suggestion-subtext {
        display:block;
        font-size:12px;
        color:#6b7280;
        margin-top:4px;
        }

        /* (keeping most of your original styling, only essential adjustments shown here) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 25px; text-align: center; display:flex; align-items:center; justify-content:space-between; gap:20px; }
        .header h1 { font-size: 1.6em; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .status-card { background: rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 8px; text-align: right; min-width:220px; font-weight:700; }

        .main-content { padding: 25px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; background: linear-gradient(312deg, #cdcdcd, #7b898b00); }
        .form-section { background: linear-gradient(45deg, #9ce8ff, transparent); padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .form-section h2 { color: #2d3748; margin-bottom: 15px; font-size: 1.1em; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display:block; margin-bottom:6px; color:#4a5568; font-weight:600; font-size:0.9em; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; background:white; }
        .btn { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.15s ease; margin:2px; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .items-table th, .items-table td { padding: 8px; text-align: left; border-bottom:1px solid #e2e8f0; font-size:13px; }
        .items-table th { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; font-weight: 600; font-size:13px; }

        .totals { background:#f8f9fa; padding:10px; border-radius:8px; margin-top:12px; }
        .totals .total-row { display:flex; justify-content:space-between; margin-bottom:6px; font-weight:600; font-size:13px; }

        .bill-output { background:#1a202c; color:#e2e8f0; padding:15px; border-radius:8px; font-family:'Courier New', monospace; white-space: pre-wrap; max-height: 500px; overflow-y:auto; margin-top:15px; font-size:12px; line-height:1.3; }

        .barcode-input { background:#fff7f7 !important; border:2px solid #ff4444 !important; font-weight:700; }
        @media (max-width:1200px) { .main-content { grid-template-columns: 1fr 1fr; gap:20px; } }
        @media (max-width:768px) { .main-content { grid-template-columns: 1fr; gap:15px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>SHRI VELAVAN SUPER MARKET</h1>
                <div style="font-size:12px; opacity:0.9;">Billing System</div>
            </div>
            <div class="status-card" id="todayStatus">
                Today's: <br>
                Items sold: <span id="todayItems">0</span><br>
                Sales: ₹<span id="todaySales">0.00</span>
            </div>
        </div>

        <div id="alerts"></div>

        <div class="main-content">
            <!-- Customer Details Section -->
            <div class="form-section" style="grid-column: span 2;">
                <h2>வாடிக்கையாளர் விவரங்கள்</h2>
                <!-- [customer fields unchanged] -->
                <div class="form-group">
                    <label for="customerMobile">மொபைல் எண்:</label>
                    <input type="tel" id="customerMobile" placeholder="மொபைல் எண் உள்ளிடவும்" maxlength="10">
                    <button type="button" class="btn" onclick="searchCustomer()">தேடு</button>
                </div>

                <div id="customerInfo" style="display:none; border-left:4px solid #3498db; padding-left:10px; margin-bottom:8px;">
                    <p><strong>பெயர்:</strong> <span id="customerName"></span></p>
                    <p><strong>முகவரி:</strong> <span id="customerAddress"></span></p>
                    <p><strong>புள்ளிகள்:</strong> <span id="customerPoints"></span></p>
                    <p><strong>கடன் இருப்பு:</strong> ₹<span id="customerBalance"></span></p>
                </div>

                <div class="form-group">
                    <label for="newCustomerName">பெயர்:</label>
                    <input type="text" id="newCustomerName" placeholder="வாடிக்கையாளர் பெயர்">
                </div>

                <div class="form-group">
                    <label for="newCustomerAddress">முகவரி:</label>
                    <textarea id="newCustomerAddress" rows="2" placeholder="முகவரி"></textarea>
                </div>

                <div style="margin-top:8px; background:#fff8e6; padding:10px; border-radius:8px; border-left:4px solid #f39c12;">
                    <h4 style="margin-bottom:6px;">கடன் இருப்பு நிர்வாகம்:</h4>
                    <div class="form-group">
                        <label for="oldBalance">பழைய கடன் இருப்பு (₹):</label>
                        <input type="number" id="oldBalance" placeholder="0.00" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label for="newDebt">புதிய கடன் (₹):</label>
                        <input type="number" id="newDebt" placeholder="0.00" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="settleDebt">கடன் தீர்க்க (₹):</label>
                        <input type="number" id="settleDebt" placeholder="0.00" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="updatedBalance">புத்ுப்பிக்கப்பட்ட இருப்பு (₹):</label>
                        <input type="number" id="updatedBalance" placeholder="0.00" step="0.01" readonly>
                    </div>
                    <button type="button" class="btn" onclick="updateBalance()">இருப்பு மாற்று</button>
                </div>
            </div>

            <!-- Product Details Section -->
            <div class="form-section">
                <h2>பொருள் விவரங்கள்</h2>
                <div class="form-group">
                    <label for="barcodeInput" style="color: red; font-weight: bold;">பார்கோட் ஸ்கேன் செய்யவும்:</label>
                    <input type="text" id="barcodeInput" class="barcode-input" placeholder="பார்கோட் ஸ்கேன் செய்யவும்" autofocus>
                </div>

                <div class="form-group">
                    <label for="productName">பொருளின் பெயர்:</label>
                    <input type="text" id="productName" placeholder="பொருளின் பெயர்" autocomplete="off">
                    <div id="productSuggestions" style="display:none; position:absolute; background:white; border:1px solid #e2e8f0; z-index:1000;"></div>
                </div>

                <div class="form-group" style="display:flex; gap:8px;">
                    <div style="flex:1;">
                        <label for="quantity">அளவு:</label>
                        <input type="number" id="quantity" placeholder="அளவு" min="1">
                    </div>
                    <div style="width:100px;">
                        <label for="unit">அலகு</label>
                        <select id="unit">
                            <option value="kg">கிலோ</option>
                            <option value="g">கிரா</option>
                            <option value="l">லிட்டர்</option>
                            <option value="count">எண்ணிக்கை</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="mrp">எம்.ஆர்.பி (₹):</label>
                    <input type="number" id="mrp" placeholder="எம்.ஆர்.பி" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label for="retailPrice">விற்பனை விலை (₹):</label>
                    <input type="number" id="retailPrice" placeholder="விற்பனை விலை" step="0.01" min="0">
                </div>

                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn" onclick="addItem()">பொருள் சேர்க்க</button>
                    <button type="button" class="btn btn-danger" onclick="clearProductForm()">அழி</button>
                </div>
            </div>

            <!-- Items Table -->
            <div class="form-section full-width" style="grid-column: span 3;">
                <h2>பொருள் பட்டியல்</h2>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>பொருளின் பெயர்</th>
                            <th>அளவு</th>
                            <th>விலை</th>
                            <th>மொத்தம்</th>
                            <th>சேமிப்பு</th>
                            <th>செயல்</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                    </tbody>
                </table>

                <div class="totals">
                    <div class="total-row"><span>மொத்த பொருட்கள்:</span><span id="totalUniqueProducts">0</span></div>
                    <div class="total-row"><span>மொத்த எண்ணிக்கை:</span><span id="totalItems">0</span></div>
                    <div class="total-row" style="font-size:15px;"><span>மொத்த தொகை:</span><span>₹<span id="subtotal">0.00</span></span></div>
                    <div class="total-row"><span>மொத்த சேமிப்பு:</span><span>₹<span id="totalSavings">0.00</span></span></div>
                    <div class="total-row"><span>சம்பாதித்த புள்ளிகள்:</span><span id="pointsEarned">0</span></div>
                </div>
            </div>

            <!-- Payment and Bill Output -->
            <div class="form-section" style="grid-column: span 2;">
                <h2>பணம் செலுத்தும் முறை</h2>
                <div class="form-group">
                    <label for="paymentType">பணம் செலுத்தும் முறை:</label>
                    <select id="paymentType">
                        <option value="பணம்">பணம்</option>
                        <option value="கார்டு">கார்டு</option>
                        <option value="UPI">UPI</option>
                        <option value="கடன்">கடன்</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cashReceived">பெற்ற பணம் (₹):</label>
                    <input type="number" id="cashReceived" placeholder="பெற்ற பணம்" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="cashBalance">திரும்ப கொடுத்த பணம் (₹):</label>
                    <input type="number" id="cashBalance" placeholder="திரும்ப கொடுத்த பணம்" step="0.01" min="0">
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="generateBill()">பில் உருவாக்க</button>
                    <button class="btn" onclick="resetForm()">மீட்டமைக்க</button>
                    <button id="printBtn" class="btn" style="display:none;" onclick="printBill()">பிரிண்ட்</button>
                </div>
            </div>

            <div class="form-section" style="grid-column: span 1;">
                <h2>பில் முன்னோட்டம்</h2>
                <div id="billOutput" class="bill-output">பில் இங்கே காண்பிக்கப்படும்...</div>
            </div>

        </div>

        <div id="loading" style="display:none; text-align:center; padding:12px;">
            <div>பதிவு செய்கிறோம்...</div>
        </div>
    </div>

    <script>
        let items = [];
        let currentCustomer = null;
        let productList = [];

        // Load product list
        function loadProductList() {
            fetch('/get_products')
                .then(r => r.json())
                .then(data => productList = data.products || [])
                .catch(err => console.error(err));
        }

        // Fetch today's totals and update UI
        function loadTodayTotals() {
            fetch('/today_totals')
                .then(r => r.json())
                .then(data => {
                    if (data && !data.error) {
                        document.getElementById('todayItems').textContent = data.total_items;
                        document.getElementById('todaySales').textContent = parseFloat(data.total_sales).toFixed(2);
                    }
                })
                .catch(err => console.error('today totals error', err));
        }

        function showAlert(message, type='success') {
            const alerts = document.getElementById('alerts');
            const div = document.createElement('div');
            div.className = 'alert';
            div.style.background = type === 'success' ? '#d5f5e3' : '#ffe6e6';
            div.style.color = type === 'success' ? '#27ae60' : '#c0392b';
            div.style.padding = '8px';
            div.style.margin = '8px';
            div.style.borderRadius = '6px';
            div.textContent = message;
            alerts.appendChild(div);
            setTimeout(()=> div.remove(), 4000);
        }

        function searchCustomer() {
            const mobile = document.getElementById('customerMobile').value.trim();
            if (!mobile) { showAlert('மொபைல் எண் உள்ளிடவும்', 'error'); return; }
            fetch('/get_customer/' + mobile)
                .then(r => {
                    if (!r.ok) throw new Error('Not found');
                    return r.json();
                })
                .then(data => {
                    currentCustomer = data;
                    document.getElementById('customerName').textContent = data.name;
                    document.getElementById('customerAddress').textContent = data.address;
                    document.getElementById('customerPoints').textContent = data.points;
                    document.getElementById('customerBalance').textContent = data.balance.toFixed(2);
                    document.getElementById('customerInfo').style.display = 'block';
                    document.getElementById('newCustomerName').value = data.name;
                    document.getElementById('newCustomerAddress').value = data.address;
                    document.getElementById('oldBalance').value = data.balance.toFixed(2);
                    document.getElementById('updatedBalance').value = data.balance.toFixed(2);
                    document.getElementById('barcodeInput').focus();
                })
                .catch(err => {
                    currentCustomer = null;
                    document.getElementById('customerInfo').style.display = 'none';
                    document.getElementById('oldBalance').value = '0.00';
                    document.getElementById('updatedBalance').value = '0.00';
                    showAlert('வாடிக்கையாளர் காணப்படவில்லை. புதிய கணக்கு உருவாக்கவும்', 'error');
                    document.getElementById('newCustomerName').focus();
                });
        }

        function updateBalance() {
            const mobile = document.getElementById('customerMobile').value.trim();
            if (!mobile) { showAlert('முதலில் வாடிக்கையாளரை தேடவும்', 'error'); return; }
            const oldBalance = parseFloat(document.getElementById('oldBalance').value) || 0;
            const newDebt = parseFloat(document.getElementById('newDebt').value) || 0;
            const settleDebt = parseFloat(document.getElementById('settleDebt').value) || 0;
            const updated = oldBalance + newDebt - settleDebt;
            fetch('/update_balance', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ mobile, balance: updated })
            }).then(r => r.json())
              .then(data => {
                if (data.success) {
                    document.getElementById('customerBalance').textContent = data.customer.balance.toFixed(2);
                    document.getElementById('updatedBalance').value = data.customer.balance.toFixed(2);
                    currentCustomer = data.customer;
                    showAlert('இருப்பு புதுப்பிக்கப்பட்டது');
                } else {
                    showAlert('பிழை: ' + (data.error || 'unknown'), 'error');
                }
              }).catch(e => showAlert('பிழை: ' + e.message, 'error'));
        }

        function fillProductDetails(product) {
            document.getElementById('mrp').value = product.mrp.toFixed(2);
            document.getElementById('retailPrice').value = product.retail_price.toFixed(2);
            const measureUnit = (product.measure || '').toLowerCase();
            const unitSelect = document.getElementById('unit');
            if (measureUnit.includes('kg')) unitSelect.value = 'kg';
            else if (measureUnit.includes('g')) unitSelect.value = 'g';
            else if (measureUnit.includes('l')) unitSelect.value = 'l';
            else unitSelect.value = 'count';
        }

        // Add item to items array and update UI
        function addItem() {
            const name = document.getElementById('productName').value.trim();
            const qtyInp = document.getElementById('quantity').value;
            const quantity = parseInt(qtyInp || '0', 10);
            const unit = document.getElementById('unit').value;
            const mrp = parseFloat(document.getElementById('mrp').value || '0');
            const retailPrice = parseFloat(document.getElementById('retailPrice').value || '0');

            if (!name || !quantity || !mrp || !retailPrice) {
                showAlert('அனைத்து பொருள் விவரங்களையும் உள்ளிடவும்', 'error');
                return;
            }
            if (quantity <= 0) { showAlert('அளவு 0 விட அதிகமாக இருக்க வேண்டும்', 'error'); return; }
            if (retailPrice > mrp) { showAlert('விற்பனை விலை எம்.ஆர்.பி.யை விட அதிகம் இல்லை', 'error'); return; }

            const idx = items.findIndex(i => i.name === name && i.unit === unit && i.mrp === mrp && i.retail_price === retailPrice);
            if (idx !== -1) {
                items[idx].quantity += quantity;
                items[idx].total = items[idx].retail_price * items[idx].quantity;
                showAlert('பொருள் அளவு புதுப்பிக்கப்பட்டது');
            } else {
                items.push({ name, quantity, unit, mrp, retail_price: retailPrice, total: retailPrice * quantity });
                showAlert('பொருள் சேர்க்கப்பட்டது');
            }
            updateItemsTable();
            clearProductForm();
        }

        function removeItem(index) {
            items.splice(index, 1);
            updateItemsTable();
            showAlert('பொருள் நீக்கப்பட்டது');
        }

        function updateItemsTable() {
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            let totalItems = 0, subtotal = 0, totalSavings = 0;
            items.forEach((item, i) => {
                const tr = document.createElement('tr');
                const savings = (item.mrp - item.retail_price) * item.quantity;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity} ${item.unit}</td>
                    <td>₹${item.retail_price.toFixed(2)}</td>
                    <td>₹${item.total.toFixed(2)}</td>
                    <td>₹${savings.toFixed(2)}</td>
                    <td><button class="btn btn-danger" onclick="removeItem(${i})">நீக்கு</button></td>
                `;
                tbody.appendChild(tr);
                totalItems += item.quantity;
                subtotal += item.total;
                totalSavings += savings;
            });
            document.getElementById('totalUniqueProducts').textContent = items.length;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('totalSavings').textContent = totalSavings.toFixed(2);
            document.getElementById('pointsEarned').textContent = Math.floor(subtotal / 100);
            calculateCashBalance();
        }

        function calculateCashBalance() {
            const subtotal = parseFloat(document.getElementById('subtotal').textContent) || 0;
            const cashReceived = parseFloat(document.getElementById('cashReceived').value || '0') || 0;
            const cashBalance = cashReceived - subtotal;
            if (cashReceived > 0) document.getElementById('cashBalance').value = cashBalance.toFixed(2);
        }

        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('mrp').value = '';
            document.getElementById('retailPrice').value = '';
            document.getElementById('barcodeInput').focus();
        }

        function generateBill() {
            const mobile = document.getElementById('customerMobile').value.trim();
            const name = document.getElementById('newCustomerName').value.trim() || (mobile ? '' : 'பதிவில்லா வாடிக்கையாளர்');
            const address = document.getElementById('newCustomerAddress').value.trim() || '-';
            const paymentType = document.getElementById('paymentType').value;
            const cashReceived = document.getElementById('cashReceived').value || 0;
            const cashBalance = document.getElementById('cashBalance').value || 0;
            const oldBalance = parseFloat(document.getElementById('oldBalance').value) || 0;
            const newDebt = parseFloat(document.getElementById('newDebt').value) || 0;
            const settleDebt = parseFloat(document.getElementById('settleDebt').value) || 0;

            if (mobile && (!name || !address)) { showAlert('மொபைல் கொடுக்கப்பட்டால் பெயர் மற்றும் முகவரி தேவை', 'error'); return; }
            if (items.length === 0) { showAlert('குறைந்தது ஒரு பொருள் சேர்க்கவும்', 'error'); return; }

            const billData = {
                customer: { mobile: mobile || '', name: name, address: address },
                items: items,
                payment: { payment_type: paymentType, cash_received: cashReceived, cash_balance: cashBalance },
                balance: { old_balance: oldBalance, new_debt: newDebt, settle_debt: settleDebt }
            };

            document.getElementById('loading').style.display = 'block';
            fetch('/create_bill', {
                method: 'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(billData)
            }).then(r => r.json())
              .then(data => {
                document.getElementById('loading').style.display = 'none';
                if (data.success) {
                    document.getElementById('billOutput').textContent = data.bill_string;
                    document.getElementById('printBtn').style.display = 'inline-block';
                    showAlert('பில் உருவாக்கப்பட்டது: ' + data.bill_number);
                    if (data.customer_data && data.customer_data.mobile !== 'N/A') {
                        document.getElementById('customerName').textContent = data.customer_data.name;
                        document.getElementById('customerAddress').textContent = data.customer_data.address;
                        document.getElementById('customerPoints').textContent = data.customer_data.points;
                        document.getElementById('customerBalance').textContent = data.customer_data.balance.toFixed(2);
                        document.getElementById('customerInfo').style.display = 'block';
                        document.getElementById('oldBalance').value = data.customer_data.balance.toFixed(2);
                        document.getElementById('updatedBalance').value = data.customer_data.balance.toFixed(2);
                        currentCustomer = data.customer_data;
                    }
                    loadTodayTotals(); // refresh today's totals after bill created
                } else {
                    showAlert('பில் தோல்வி: ' + (data.error||'Unknown'), 'error');
                }
              }).catch(e => {
                document.getElementById('loading').style.display = 'none';
                showAlert('பில் தோல்வி: ' + e.message, 'error');
              });
        }

        function printBill() {
            const billContent = document.getElementById('billOutput').textContent;
            if (!billContent || billContent.includes('இங்கே')) { showAlert('முதலில் பில் உருவாக்கவும்', 'error'); return; }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>பில் பிரிண்ட்</title>
                <style>
                    @page { size: 58mm auto; margin: 3mm; }
                    body { font-family: 'Courier New', monospace; font-size: 10px; line-height:1.15; white-space: pre-wrap; margin:0; padding:2mm; width:58mm; }
                    @media print { body { margin:0; padding:0; } }
                </style>
                </head><body>${billContent.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</body></html>
            `);
            printWindow.document.close();
            printWindow.print();
            showAlert('பில் பிரிண்ட் அனுப்பப்பட்டது');
        }

        function resetForm() {
            if (!confirm('படிவத்தை மீட்டமைக்க விரும்புகிறீர்களா?')) return;
            document.getElementById('customerMobile').value = '';
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerAddress').value = '';
            document.getElementById('oldBalance').value = '';
            document.getElementById('newDebt').value = '0';
            document.getElementById('settleDebt').value = '0';
            document.getElementById('updatedBalance').value = '';
            document.getElementById('paymentType').value = 'பணம்';
            document.getElementById('cashReceived').value = '';
            document.getElementById('cashBalance').value = '';
            items = [];
            currentCustomer = null;
            updateItemsTable();
            clearProductForm();
            document.getElementById('billOutput').textContent = 'பில் இங்கே காண்பிக்கப்படும்...';
            document.getElementById('printBtn').style.display = 'none';
            showAlert('படிவம் மீட்டமைந்தது');
            document.getElementById('customerMobile').focus();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); addItem(); }
            if (e.ctrlKey && e.key === 'b') { e.preventDefault(); generateBill(); }
            if (e.ctrlKey && e.key === 'p') { e.preventDefault(); printBill(); }
            if (e.key === 'F5') { e.preventDefault(); searchCustomer(); }
        });

        document.getElementById('barcodeInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = this.value.trim();
                if (!barcode) return;

                fetch('/get_product_by_barcode/' + barcode)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            const product = data.product;
                            document.getElementById('productName').value = product.name;
                            fillProductDetails(product);

                            // Default quantity = 1
                            document.getElementById('quantity').value = 1;

                            // Directly add item
                            addItem();
                        } else {
                            showAlert('பார்கோடு பொருள் கிடைக்கவில்லை', 'error');
                        }
                    })
                    .catch(err => showAlert('பார்கோட் பிழை: ' + err.message, 'error'));
                this.value = '';
            }
        });
            
        document.getElementById('productName').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const val = this.value.trim();
                if (!val) return;

                fetch('/get_product_by_name/' + encodeURIComponent(val))
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            fillProductDetails(data.product);

                            // Default quantity = 1 if not given
                            if (!document.getElementById('quantity').value) {
                                document.getElementById('quantity').value = 1;
                            }

                            // Directly add item
                            addItem();
                        } else {
                            showAlert('பொருள் கிடைக்கவில்லை', 'error');
                        }
                    })
                    .catch(() => showAlert('தேடல் பிழை', 'error'));
            }
        });


        // navigation shortcuts
        document.getElementById('quantity').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('mrp').focus(); }});
        document.getElementById('mrp').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('retailPrice').focus(); }});
        document.getElementById('retailPrice').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); addItem(); }});
        document.getElementById('cashReceived').addEventListener('input', calculateCashBalance);

        // Update preview balance
        document.getElementById('newDebt').addEventListener('input', updateBalancePreview);
        document.getElementById('settleDebt').addEventListener('input', updateBalancePreview);
        function updateBalancePreview() {
            const oldBalance = parseFloat(document.getElementById('oldBalance').value) || 0;
            const newDebt = parseFloat(document.getElementById('newDebt').value) || 0;
            const settleDebt = parseFloat(document.getElementById('settleDebt').value) || 0;
            document.getElementById('updatedBalance').value = (oldBalance + newDebt - settleDebt).toFixed(2);
        }

        // format mobile input
        document.getElementById('customerMobile').addEventListener('input', function() {
            let v = this.value.replace(/\D/g,'');
            if (v.length > 10) v = v.slice(0,10);
            this.value = v;
        });

  // --- Autocomplete logic for productName ---
  const prodInput = document.getElementById('productName');
  const suggBox = document.getElementById('productSuggestions');
  let suggIndex = -1;
  let currentMatches = [];

  // Helper: render suggestions
  function renderSuggestions(matches) {
    suggBox.innerHTML = '';
    if (!matches || matches.length === 0) {
      suggBox.style.display = 'none';
      return;
    }
    matches.forEach((m, idx) => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.dataset.index = idx;
      div.innerHTML = `<div>${m}</div>`;
      // optional subtext could be product unit or category if you want
      div.addEventListener('mousedown', (ev) => {
        // use mousedown (not click) so it runs before blur
        ev.preventDefault();
        selectSuggestion(idx);
      });
      suggBox.appendChild(div);
    });
    suggBox.style.display = 'block';
  }

  // Compute and show matches
  prodInput.addEventListener('input', function () {
    const v = this.value.trim().toLowerCase();
    if (!v) { renderSuggestions([]); return; }
    currentMatches = productList.filter(p => p && p.toLowerCase().includes(v)).slice(0, 8);
    renderSuggestions(currentMatches);
    suggIndex = -1;
  });

  // Keyboard navigation (arrow keys + enter)
  prodInput.addEventListener('keydown', function (e) {
    if (suggBox.style.display === 'none') return;
    const items = suggBox.querySelectorAll('.suggestion-item');
    if (!items || items.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      suggIndex = (suggIndex + 1) % items.length;
      updateActiveSuggestion(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      suggIndex = (suggIndex - 1 + items.length) % items.length;
      updateActiveSuggestion(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (suggIndex >= 0 && suggIndex < items.length) {
        selectSuggestion(suggIndex);
      } else {
        // No highlighted suggestion - try to lookup exact name and auto-add
        const val = this.value.trim();
        if (val) searchAndAutoAddByName(val);
      }
    } else if (e.key === 'Escape') {
      suggBox.style.display = 'none';
    }
  });

  function updateActiveSuggestion(items) {
    items.forEach(it => it.classList.remove('suggestion-active'));
    if (suggIndex >= 0 && items[suggIndex]) items[suggIndex].classList.add('suggestion-active');
  }

  // Called when user selects a suggestion (by click or keyboard)
  function selectSuggestion(idx) {
    const name = currentMatches[idx];
    if (!name) return;
    prodInput.value = name;
    suggBox.style.display = 'none';
    // Fill details from server by name, then auto-add
    searchAndAutoAddByName(name);
  }

  // Search product by name on server, fill details, set qty=1 if empty, and auto-add
  function searchAndAutoAddByName(name) {
    fetch('/get_product_by_name/' + encodeURIComponent(name))
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          const product = data.product;
          fillProductDetails(product);
          if (!document.getElementById('quantity').value) document.getElementById('quantity').value = 1;
          // small debounce to allow UI to update
          setTimeout(() => addItem(), 30);
        } else {
          showAlert('பொருள் கிடைக்கவில்லை: ' + name, 'error');
        }
      })
      .catch(err => {
        console.error(err);
        showAlert('தேடல் தவறு', 'error');
      });
  }

    // Hide suggestions on blur (but allow suggestion click to proceed)
    prodInput.addEventListener('blur', () => {
        setTimeout(() => { suggBox.style.display = 'none'; }, 120);
    });

    // On focus, if input has value, trigger suggestions
    prodInput.addEventListener('focus', () => {
        const v = prodInput.value.trim().toLowerCase();
        if (v) {
        currentMatches = productList.filter(p => p && p.toLowerCase().includes(v)).slice(0, 8);
        renderSuggestions(currentMatches);
        }
    });

    // Ensure suggestion box is positioned near input (optional tweak)
    // If your layout wraps productName in a relative container, this may be unnecessary.
    // Otherwise, set suggBox width and left relative to input:
    (function positionSuggestionBox() {
        const rect = prodInput.getBoundingClientRect();
        // adjust CSS if needed — already set width via CSS calc
    })();
    // --- Page init: make sure product list and totals load on start ---
    document.addEventListener('DOMContentLoaded', function() {
        loadProductList();
        loadTodayTotals();
        // if you want focus on barcode first:
        const bc = document.getElementById('barcodeInput');
        if (bc) bc.focus();
    });

    </script>
</body>
</html>
